name: OpenRV

on:
  push:
    branches:
      # This will run when PR is merged or direct pushes to main.
      - main

  pull_request: # This handles PR creation and subsequent commits.

  schedule:
    # Midnight build every day
    - cron: "0 0 * * *"

  # This allows manual triggering of the workflow from the web
  workflow_dispatch:
    inputs:
      SKIP_DEPS_CACHE:
        description: 'Skip dependencies caching'
        required: true
        default: 'false'

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    #if: ${{ github.repository_owner == 'AcademySoftwareFoundation' }}
    outputs:
      cmake_changed: ${{ steps.filter.outputs.cmake }}
    steps:
      - name: Check out repository code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
      - name: Detect cmake file changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3
        id: filter
        with:
          filters: |
            cmake:
              - 'cmake/**'
              - '**/CMakeLists.txt'
              - '**/*.cmake'

  linux:
    needs: detect-changes
    uses: ./.github/workflows/ci-linux.yml
    with:
      skip_deps_cache: ${{ inputs.SKIP_DEPS_CACHE || 'false' }}
      qt5_modules: 'debug_info qtcharts qtdatavis3d qtlottie qtnetworkauth qtquick3d qtquicktimeline qtscript qtwebengine qtwebglplugin'
      run_debug: ${{ needs.detect-changes.outputs.cmake_changed == 'true' || github.event_name == 'schedule' }}
      run_cy2023: ${{ github.event_name != 'pull_request' }}

  macos:
    needs: detect-changes
    uses: ./.github/workflows/ci-macos.yml
    with:
      skip_deps_cache: ${{ inputs.SKIP_DEPS_CACHE || 'false' }}
      qt5_modules: 'debug_info qtcharts qtdatavis3d qtlottie qtnetworkauth qtquick3d qtquicktimeline qtscript qtwebengine qtwebglplugin'
      run_debug: ${{ needs.detect-changes.outputs.cmake_changed == 'true' || github.event_name == 'schedule' }}

  windows:
    needs: detect-changes
    uses: ./.github/workflows/ci-windows.yml
    with:
      skip_deps_cache: ${{ inputs.SKIP_DEPS_CACHE || 'false' }}
      qt5_modules: 'debug_info qtcharts qtdatavis3d qtlottie qtnetworkauth qtquick3d qtquicktimeline qtscript qtwebengine qtwebglplugin'
      run_debug: ${{ needs.detect-changes.outputs.cmake_changed == 'true' || github.event_name == 'schedule' }}
      run_cy2023: ${{ github.event_name != 'pull_request' }}