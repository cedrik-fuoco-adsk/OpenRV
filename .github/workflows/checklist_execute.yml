name: 'Handle Checkbox Changes'
on:
  pull_request:
    types: [edited]
  pull_request_target:
    types: [edited]

permissions:
  pull-requests: write
  statuses: write
  checks: write
  contents: read

jobs:
  execute:
    runs-on: ubuntu-latest
    steps:
      - name: Debug Event
        uses: actions/github-script@v7
        with:
          script: |
            console.log('=== DEBUG INFO ===');
            console.log('Event name:', context.eventName);
            console.log('Event action:', context.payload.action);
            console.log('PR number:', context.payload.pull_request?.number);
            console.log('PR SHA:', context.payload.pull_request?.head?.sha);
            console.log('==================');
      
      - name: Parse Checklist and Update Statuses
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const checklistBody = pr.body || '';
            
            // Check if this PR has a checklist
            if (!checklistBody.includes('PR Checklist')) {
              console.log('‚ùå No checklist found in PR description, skipping');
              return;
            }
            
            console.log('‚úì Checklist found in PR description');
            console.log('PR body length:', checklistBody.length);
            
            // Parse checkbox states with improved regex
            const checkboxes = {
              'lint-format': /- \[(x|X| )\] \*\*lint-format\*\*/.exec(checklistBody)?.[1]?.trim().toLowerCase() === 'x',
              'rocky-linux': /- \[(x|X| )\] \*\*rocky-linux\*\*/.exec(checklistBody)?.[1]?.trim().toLowerCase() === 'x',
              'macos': /- \[(x|X| )\] \*\*macos\*\*/.exec(checklistBody)?.[1]?.trim().toLowerCase() === 'x',
              'windows': /- \[(x|X| )\] \*\*windows\*\*/.exec(checklistBody)?.[1]?.trim().toLowerCase() === 'x'
            };
            
            console.log('üìã Checkbox states:', JSON.stringify(checkboxes, null, 2));
            
            // Update status for each checkbox
            let updatedCount = 0;
            for (const [check, isChecked] of Object.entries(checkboxes)) {
              const state = isChecked ? 'success' : 'pending';
              const description = isChecked 
                ? '‚úÖ Approved via checklist' 
                : 'Waiting for checklist approval';
              
              try {
                await github.rest.repos.createCommitStatus({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  sha: pr.head.sha,
                  state: state,
                  context: `checklist/${check}`,
                  description: description,
                  target_url: pr.html_url
                });
                console.log(`‚úì Updated checklist/${check} ‚Üí ${state}`);
                updatedCount++;
              } catch (error) {
                console.error(`‚úó Failed to update checklist/${check}:`, error.message);
              }
            }
            
            console.log(`\nüéâ Successfully updated ${updatedCount}/4 status checks`);